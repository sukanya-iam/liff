<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover">
    <title>My LIFF app</title>
    <link rel="stylesheet" href="css/style.css" media="all">
</head>

<body>
    <h2 style="color: rgb(2, 92, 177); text-align: center;">Line liff <span id="spVersion"></span></h2>
    <button id="btnSendNoti" style="display: none;">Send Noti</button>
    <h4 style="color: red;" id="errorMsg"></h4>
    <hr>
    <h3 class="head-info">Get Environment</h3>
    <p id="os"><b>OS:</b> </p>
    <p id="language"><b>Language:</b> </p>
    <p id="version"><b>Version:</b> </p>
    <p id="isInClient"><b>isInClient:</b> </p>
    <p id="accessToken"><b>AccessToken:</b> </p>
    <hr>
    <h3 class="head-info">Get Profile</h3>
    <img id="pictureUrl">
    <p id="userId"><b>userId:</b> </p>
    <p id="displayName"><b>displayName:</b> </p>
    <p id="statusMessage"><b>statusMessage:</b> </p>
    <p id="decodedIDToken"><b>email:</b> </p>
    <button id="btnShowProfile">Profile</button>
    <hr>
    <h3 class="head-info">Get Context</h3>
    <p id="type"><b>type:</b> </p>
    <p id="viewType"><b>viewType:</b> </p>
    <p id="utouId"><b>utouId:</b> </p>
    <p id="roomId"><b>roomId:</b> </p>
    <p id="groupId"><b>groupId:</b> </p>
    <hr>
    <h3 class="head-info">Other</h3>
    <p id="friendship"><b>isFriendship:</b> </p>
    <p id="scanCode"><b>Code:</b> </p>
    <p id="isLoggedIn"><b>isLoggedIn:</b> </p>
    <p id="universalLink1"><b>Universal Link:</b> </p>
    <p id="universalLink2"><b>Universal Link with Query params:</b> </p>
    <p><a href="https://sukanya-iam.github.io/liff/path/index?param=9">Link to Path</a></p>

    <button id="btnMsg" onclick="sendMsg()">Send Message</button>
    <button id="btnShare" onclick="shareMsg()">Share Target Picker</button>
    <button onclick="openWindow()">Open Window</button>
    <button id="btnScanCode" onclick="scanCode()">Scan Code</button>
    <button id="btnLogOut" onclick="logOut()">Log Out</button>
    <button id="btnClose" onclick="closed()">Close</button>

    <!-- <script src="js/vconsole.min.js"></script> -->
    <!-- <script>
      var vConsole = new VConsole()
      console.log("Hello World!")
    </script> -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        var userProfile = null;

        async function main() {
            $('#spVersion').text('V38.3');
            await liff
                .init({
                    liffId: "2004905818-LqwOoRkn", // Use own liffId
                })
                .then(() => {
                    // Start to use liff's api
                    getEnvironment();
                    //getUserProfile();
                    //getContext();
                })
                .catch((err) => {
                    // Error happens during initialization
                    $('#errorMsg').text("main , " + err.code + " : " + err.message);
                });
        }
        main();

        function getEnvironment() {
            try {
                // ดึงค่า Language, version, isInClient, AccessToken มาแสดง
                // liff เปิดใน android, ios หรือ web
                $("#os").append(liff.getOS());
                // defualt language ของ client
                $("#language").append(liff.getLanguage());
                // version ของ liff ที่ถกเปิด
                $("#version").append(liff.getVersion());
                // อันนี้เป็นค่าชั่วคราว เพื่อให้เรา access ไปที่หลังบ่านของ LINE ได้
                $("#accessToken").append(liff.getAccessToken());
                // ผู้ใช่เปิด liff จาก LINE หรือ External browser --> จะได้ซ่อน feature แล้วแต่แพล็ตฟอร์มที่เปิดได้
                $("#isInClient").append(liff.isInClient());
                if (liff.isInClient()) {
                    // TRUE - ค่าสั่ง liff.init ถ้าเปิดจากแอพ line มันจะ log in ให้อยู่แล้ว
                    $("#btnLogOut").css('display', 'none');
                }
                else {
                    // FALSE - 3 ปุมนี้ทำไม่ได้ถ้าเปิดจาก external browser
                    $("#btnMsg").css('display', 'none');
                    $("#btnScanCode").css('display', 'none');
                    $("#btnClose").css('display', 'none');
                }
            }
            catch (err) {
                $('#errorMsg').text("Envi , " + err.message);
            }

        }

        async function getUserProfile() {
            await liff
                .getProfile()
                .then((profile) => {
                    if (profile != null) {
                        $("#displayName").append(profile.displayName);
                        // เอา url property ของ profile ไปใส่เป็นค่าของ src ใน img tag
                        $("#pictureUrl").attr('src', profile.pictureUrl);
                        $("#userId").append(profile.userId);
                        $("#statusMessage").append(profile.statusMessage);
                        // email เป็นค่าที่อยู่ใน openId เลยต้องไปตั้งค่า scope ใน console ด้วย
                        $("#decodedIDToken").append(liff.getDecodedIDToken().email);

                        userProfile = {
                            userId: profile.userId,
                            displayName: profile.displayName,
                            pictureUrl: profile.pictureUrl,
                            email: liff.getDecodedIDToken().email
                        }
                    } else {
                        $('#errorMsg').text("profile null");
                    }
                })
                .catch((err) => {
                    $('#errorMsg').text("getProfile() is error , " + err);
                });
        }

        function getContext() {
            // utou (1-on-1 chat), group, room, none(external browser)
            $("#type").append(liff.getContext().type);
            // compact, tall, full size
            $("#viewType").append(liff.getContext().viewType);
            // for 1-on-1 chat where liff was opened
            $("#utouId").append(liff.getContext().utouId);
            // for room chat where liff was opened
            $("#roomId").append(liff.getContext().roomId);
            // for group chat where liff was opened
            $("#groupId").append(liff.getContext().groupId);
        }

        $('#btnShowProfile').click(function () {
            alert(JSON.stringify(userProfile));
        });

        $('#btnSendNoti').click(function () {
            if (userProfile == null) {
                alert("userProfile is null");
            } else {
                $.ajax({
                    type: 'POST',
                    url: 'https://app-scgltruckgo-dev-001.azurewebsites.net/truckgo/appapi/Notification/SendAssigned',
                    data: {
                        DriverCode: "0822222222",
                        ShipmentNo: "BTTEST01",
                        DeliveryNotes: [{
                            OriginName: userProfile.displayName,
                            ShiptoName: userProfile.statusMessage
                        }]
                    },
                    dataType: "json",
                    success: function (result) {
                        alert("result : " + JSON.stringify(result));
                    },
                    error: function (request, status, error) {
                        alert(JSON.stringify(request) + " | Status : " + status);
                    },
                });
            }
        });

        function createUniversalLink() {
        }

        async function shareMsg() {
        }

        function logOut() {
        }

        function closed() {
        }

        async function scanCode() {
        }

        function openWindow() {
        }

        async function getFriendship() {
        }

        async function sendMsg() {
        }

    </script>
</body>

</html>